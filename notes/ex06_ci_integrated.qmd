---
title: "SesiÃ³n 6: Intervalos de Confianza"
format: html
filters:
  - webr
---

# Caso: EvaluaciÃ³n de Programa de Control de Diabetes

Un programa piloto de salud pÃºblica busca reducir el Ã­ndice de masa corporal (IMC) en pacientes diabÃ©ticos. Se comparan dos grupos: **tratamiento** (programa intensivo) vs **control** (atenciÃ³n estÃ¡ndar).

**Pregunta:** Â¿El programa funciona? Â¿Con quÃ© nivel de certeza?

```{webr-r}
set.seed(2026)

# Simular datos de 200 pacientes
n_trat <- 100
n_control <- 100

# Grupo tratamiento: IMC reducido (media 28, DE 4)
imc_tratamiento <- rnorm(n_trat, mean=28, sd=4)

# Grupo control: IMC mayor (media 30, DE 4.5)
imc_control <- rnorm(n_control, mean=30, sd=4.5)

datos <- data.frame(
  imc = c(imc_tratamiento, imc_control),
  grupo = rep(c("Tratamiento", "Control"), c(n_trat, n_control))
)

head(datos)
```

---

# Parte 1: EstadÃ­sticas Descriptivas por Grupo

```{webr-r}
cat("ðŸ“Š COMPARACIÃ“N DE GRUPOS\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")

by(datos$imc, datos$grupo, summary)

# T-test para comparar medias
resultado <- t.test(imc ~ grupo, data=datos)

cat("\nðŸ’¡ DIFERENCIA DE MEDIAS\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n")
cat("Media Control:       ", round(resultado$estimate[1], 2), "\n")
cat("Media Tratamiento:   ", round(resultado$estimate[2], 2), "\n")
cat("Diferencia:          ", round(resultado$estimate[1] - resultado$estimate[2], 2), " puntos IMC\n")
cat("IC 95%:              [", round(resultado$conf.int[1], 2), ", ", 
    round(resultado$conf.int[2], 2), "]\n")
cat("p-valor:             ", format.pval(resultado$p.value, digits=3), "\n\n")
```

---

# Parte 2: VisualizaciÃ³n con Intervalos

```{webr-r}
# Boxplot con IC
boxplot(imc ~ grupo, data=datos,
        col=c("#4ECDC4", "#FF6B6B"),
        main="IMC por Grupo con IC 95%",
        ylab="Ãndice de Masa Corporal")

# Agregar puntos de media Â± IC
medias <- tapply(datos$imc, datos$grupo, mean)
errores <- tapply(datos$imc, datos$grupo, function(x) {
  1.96 * sd(x) / sqrt(length(x))
})

points(1:2, medias, pch=18, cex=2.5, col="blue")
arrows(1:2, medias - errores, 1:2, medias + errores, 
       code=3, angle=90, length=0.1, lwd=2, col="blue")

legend("topright",
       legend=c("Media Â± IC95%"),
       pch=18, col="blue", bty="n")
```

---

# Parte 3: InterpretaciÃ³n del IC

```{webr-r}
cat("\nðŸŽ¯ INTERPRETACIÃ“N DEL IC 95%\n")
cat("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n")

dif <- resultado$estimate[1] - resultado$estimate[2]
ic_lower <- resultado$conf.int[1]
ic_upper <- resultado$conf.int[2]

cat("La diferencia estimada es:", round(dif, 2), "puntos de IMC\n")
cat("Con 95% de confianza, la verdadera diferencia estÃ¡ entre:\n")
cat("  ", round(ic_lower, 2), "y", round(ic_upper, 2), "\n\n")

if (ic_lower > 0 & ic_upper > 0) {
  cat("âœ… CONCLUSIÃ“N: El intervalo NO incluye cero.\n")
  cat("   Podemos afirmar con 95% de confianza que hay diferencia.\n")
  cat("   El tratamiento parece reducir el IMC.\n\n")
} else if (ic_lower < 0 & ic_upper < 0) {
  cat("âŒ El tratamiento AUMENTA el IMC (resultado adverso)\n\n")
} else {
  cat("âš ï¸  El intervalo INCLUYE cero.\n")
  cat("   No podemos descartar que la diferencia sea por azar.\n\n")
}

cat("âš ï¸  LIMITACIÃ“N: Esto NO prueba causalidad.\n")
cat("   Puede haber variables confusoras (edad, sexo, adherencia).\n")
```

---

# Parte 4: SimulaciÃ³n de 100 ICs

```{webr-r}
# Demostrar quÃ© significa "95% de confianza"
n_sims <- 100
contiene_verdad <- 0
diferencia_verdadera <- 2  # Asumida

resultados_ic <- data.frame()

for (i in 1:n_sims) {
  muestra_t <- rnorm(50, mean=28, sd=4)
  muestra_c <- rnorm(50, mean=30, sd=4.5)
  
  test <- t.test(muestra_t, muestra_c)
  dif_obs <- mean(muestra_c) - mean(muestra_t)
  
  ic_low <- test$conf.int[1]
  ic_high <- test$conf.int[2]
  
  captura <- (ic_low <= diferencia_verdadera) & (diferencia_verdadera <= ic_high)
  if (captura) contiene_verdad <- contiene_verdad + 1
  
  resultados_ic <- rbind(resultados_ic, data.frame(
    sim = i,
    diferencia = dif_obs,
    ic_low = ic_low,
    ic_high = ic_high,
    captura = captura
  ))
}

cat("\nDe", n_sims, "intervalos al 95% de confianza:\n")
cat("Contienen el valor verdadero:", contiene_verdad, "(", 
    round(100*contiene_verdad/n_sims), "%)\n")
cat("No lo contienen:            ", n_sims - contiene_verdad, "\n\n")

# Plot de los ICs
plot(1:n_sims, resultados_ic$diferencia, 
     ylim=range(c(resultados_ic$ic_low, resultados_ic$ic_high)),
     pch=19, cex=0.5,
     col=ifelse(resultados_ic$captura, "blue", "red"),
     main="100 Intervalos de Confianza al 95%",
     xlab="SimulaciÃ³n", ylab="Diferencia estimada")

for (i in 1:n_sims) {
  segments(i, resultados_ic$ic_low[i], i, resultados_ic$ic_high[i],
           col=ifelse(resultados_ic$captura[i], "blue", "red"))
}

abline(h=diferencia_verdadera, col="darkgreen", lwd=3, lty=2)
text(50, diferencia_verdadera+0.5, "Verdad = 2.0", col="darkgreen")

legend("topright",
       legend=c("Captura verdad", "No captura"),
       col=c("blue", "red"), pch=19, bty="n")
```

---

# Ejercicio Individual

1. **Calcula IC 90%** (en vez de 95%) - Â¿QuÃ© cambia?
2. **PropÃ³n** tamaÃ±o de muestra para IC mÃ¡s estrecho
3. **Escribe** memo de 1 pÃ¡gina comunicando resultado

---

# DiscusiÃ³n

- Â¿"95% de confianza" significa "95% de probabilidad"?
- Â¿CÃ³mo comunicas incertidumbre a decisores?
- Â¿QuÃ© haces si IC es muy ancho?

