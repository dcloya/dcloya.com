---
title: "Sesi√≥n 10: Paradoja de Simpson"
format: html
filters:
  - webr
---

# Caso: Presupuesto y Desempe√±o Escolar Revisitado

Usaremos los datos de escuelas de la Sesi√≥n 2, pero ahora **controlando por tipo**.

```{webr-r}
set.seed(2026)
n_urb <- 80
n_rur <- 40

# Urbanas: m√°s presupuesto, mayor efecto base
presup_urb <- rnorm(n_urb, mean=8, sd=2)
puntaje_urb <- 55 + 2.5*presup_urb + rnorm(n_urb, 0, 8) + 5

# Rurales: menor presupuesto, mayor retorno marginal
presup_rur <- rnorm(n_rur, mean=5, sd=1.5)
puntaje_rur <- 45 + 4*presup_rur + rnorm(n_rur, 0, 6)

datos <- data.frame(
  presupuesto = c(presup_urb, presup_rur),
  puntaje = c(puntaje_urb, puntaje_rur),
  tipo = c(rep("Urbana", n_urb), rep("Rural", n_rur))
)
```

---

# Parte 1: Regresi√≥n Simple (INGENUA)

```{webr-r}
# Modelo SIN controlar por tipo
m1 <- lm(puntaje ~ presupuesto, data=datos)

cat("üìä MODELO 1 (sin tipo de escuela)\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n")
cat("Coeficiente presupuesto: ", round(coef(m1)[2], 3), "\n")
cat("R¬≤:                      ", round(summary(m1)$r.squared, 3), "\n\n")

# Scatterplot
plot(datos$presupuesto, datos$puntaje, 
     pch=19, col=rgb(0,0,0,0.4),
     main="Regresi√≥n Simple (Ignora Tipo)",
     xlab="Presupuesto", ylab="Puntaje")
abline(m1, col="red", lwd=3)
```

---

# Parte 2: Regresi√≥n M√∫ltiple (CONTROLANDO)

```{webr-r}
# Modelo controlando por tipo
m2 <- lm(puntaje ~ presupuesto + tipo, data=datos)

cat("\nüìä MODELO 2 (controlando por tipo)\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n")
summary(m2)

cat("\nüí° COMPARACI√ìN DE COEFICIENTES\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n")
cat("Modelo 1 (sin tipo):  Œ≤ =", round(coef(m1)[2], 3), "\n")
cat("Modelo 2 (con tipo):  Œ≤ =", round(coef(m2)[2], 3), "\n")
cat("Diferencia:                ", round(coef(m2)[2] - coef(m1)[2], 3), "\n\n")

cat("‚ö†Ô∏è  PARADOJA DE SIMPSON:\n")
cat("   El coeficiente CAMBI√ì al controlar por tipo.\n")
cat("   Esto indica que 'tipo' es una variable CONFUSORA.\n\n")
```

---

# Parte 3: Visualizaci√≥n de Simpson

```{webr-r}
# Plot con colores por tipo
plot(datos$presupuesto, datos$puntaje,
     pch=19, col=ifelse(datos$tipo=="Urbana", "red", "blue"),
     main="Paradoja de Simpson Visualizada",
     xlab="Presupuesto", ylab="Puntaje")

# L√≠nea global (roja)
abline(m1, col="gray", lwd=3, lty=2)

# L√≠neas por tipo
urbanas <- datos[datos$tipo=="Urbana",]
rurales <- datos[datos$tipo=="Rural",]
abline(lm(puntaje ~ presupuesto, data=urbanas), col="red", lwd=2)
abline(lm(puntaje ~ presupuesto, data=rurales), col="blue", lwd=2)

legend("bottomright",
       legend=c("Urbanas", "Rurales", "Global (enga√±oso)"),
       col=c("red", "blue", "gray"),
       lty=c(1,1,2), lwd=c(2,2,3), bty="n")
```

---

# Parte 4: Implicaciones para Pol√≠tica

```{webr-r}
cat("\nüéØ LECCI√ìN PARA POL√çTICA P√öBLICA\n")
cat("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n")

cat("MODELO INGENUO dice:\n")
cat("  'Cada $1k de presupuesto ‚Üí +", round(coef(m1)[2], 2), " puntos'\n")
cat("  Pero ignora que escuelas urbanas:\n")
cat("    ‚Ä¢ Tienen M√ÅS presupuesto\n")
cat("    ‚Ä¢ Tienen ventaja estructural (infraestructura, maestros)\n\n")

cat("MODELO CORRECTO dice:\n")
cat("  Controlando por tipo, cada $1k ‚Üí +", round(coef(m2)[2], 2), " puntos\n")
cat("  Y escuelas rurales tienen desventaja de -", 
    abs(round(coef(m2)[3], 2)), " puntos\n")
cat("  (incluso con igual presupuesto)\n\n")

cat("RECOMENDACI√ìN:\n")
cat("  No basta con igualar presupuestos.\n")
cat("  Hay que compensar las desventajas estructurales.\n")
```

---

# Ejercicio Individual

1. **Simula** un caso donde la relaci√≥n se INVIERTE al controlar
2. **Identifica** 3 variables omitidas en este modelo
3. **Prop√≥n** dise√±o de estudio que minimice confusi√≥n

---

# Discusi√≥n

- ¬øCu√°ndo sospechar de una variable confusora?
- ¬øQu√© variables siempre debes controlar en educaci√≥n?
- ¬øExperimento aleatorio vs regresi√≥n: pros/contras?

